<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:ComCross.Shell.ViewModels"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="ComCross.Shell.Views.MessageStreamView"
             x:DataType="vm:MainWindowViewModel"
             x:Name="Root"
             TimestampFormat="{Binding TimestampFormat}"
             MessageFontFamily="{Binding MessageFontFamily}"
             MessageFontSize="{Binding MessageFontSize}">
    
    <Grid RowDefinitions="Auto,Auto,*">
        <!-- Search Bar -->
        <Border Grid.Row="0" Background="#141B1F" Padding="16" BorderBrush="#25303A" BorderThickness="0,0,0,1">
            <TextBox Text="{Binding SearchQuery}" 
                     Watermark="{Binding LocalizedStrings.StreamSearchPlaceholder}" 
                     Background="#1B242A"
                     BorderBrush="#25303A" />
        </Border>

        <!-- Metrics Bar -->
        <Border Grid.Row="1" Background="#141B1F" Padding="16,8" BorderBrush="#25303A" BorderThickness="0,0,0,1">
            <Grid ColumnDefinitions="*,Auto">
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="24" VerticalAlignment="Center">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="{Binding LocalizedStrings.StreamMetricsRx}" FontSize="10" Foreground="#87909B" VerticalAlignment="Center" />
                        <TextBlock Text="{Binding ActiveSession.RxBytes}" FontSize="12" Foreground="#2CB5A9" FontWeight="Bold" VerticalAlignment="Center" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="{Binding LocalizedStrings.StreamMetricsTx}" FontSize="10" Foreground="#87909B" VerticalAlignment="Center" />
                        <TextBlock Text="{Binding ActiveSession.TxBytes}" FontSize="12" Foreground="#3AA0FF" FontWeight="Bold" VerticalAlignment="Center" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="{Binding LocalizedStrings.StreamMetricsLines}" FontSize="10" Foreground="#87909B" VerticalAlignment="Center" />
                        <TextBlock Text="{Binding Messages.Count}" FontSize="12" Foreground="#E6EDF3" FontWeight="Bold" VerticalAlignment="Center" />
                    </StackPanel>
                </StackPanel>
                
                <!-- Database Storage Toggle -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                    <CheckBox IsChecked="{Binding ActiveSession.EnableDatabaseStorage}" 
                              Content="{Binding LocalizedStrings.SessionDatabaseEnable}"
                              FontSize="11"
                              VerticalAlignment="Center" />
                    <Border Background="#F5A524" CornerRadius="8" Width="16" Height="16" VerticalAlignment="Center"
                            ToolTip.Tip="{Binding LocalizedStrings.SessionDatabaseTooltip}">
                        <TextBlock Text="?" FontSize="11" FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="#141B1F" />
                    </Border>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Message List -->
        <ListBox Grid.Row="2"
                 x:Name="MessageList"
                 ItemsSource="{Binding Messages}" 
                 Background="#0F1417" 
                 BorderThickness="0"
                 SelectionMode="Single"
                 ScrollViewer.HorizontalScrollBarVisibility="Auto"
                 ScrollViewer.VerticalScrollBarVisibility="Auto">
            <ListBox.ItemTemplate>
                <DataTemplate>
                    <Border Padding="8,2" BorderBrush="#25303A" BorderThickness="0,0,0,1">
                        <Grid ColumnDefinitions="Auto,Auto,Auto,*" Height="20">
                            <!-- Direction Indicator (TX/RX) -->
                            <Border Grid.Column="0" Width="2" Background="{Binding Source, Converter={StaticResource DirectionColorConverter}}" Margin="0,0,8,0" CornerRadius="1" VerticalAlignment="Stretch" />
                            
                            <!-- Timestamp -->
                            <TextBlock Grid.Column="1" 
                                       FontFamily="{Binding MessageFontFamily, ElementName=Root}" 
                                       FontSize="{Binding MessageFontSize, ElementName=Root}" 
                                       Foreground="#6B7780" 
                                       Margin="0,0,8,0"
                                       VerticalAlignment="Center">
                                <TextBlock.Text>
                                    <MultiBinding Converter="{StaticResource TimestampFormatConverter}">
                                        <Binding Path="Timestamp" />
                                        <Binding Path="TimestampFormat" ElementName="Root" />
                                    </MultiBinding>
                                </TextBlock.Text>
                            </TextBlock>
                            
                            <!-- Direction (TX/RX) -->
                            <TextBlock Grid.Column="2"
                                       Text="{Binding Source}"
                                       FontFamily="{Binding MessageFontFamily, ElementName=Root}"
                                       FontSize="{Binding MessageFontSize, ElementName=Root}"
                                       FontWeight="SemiBold"
                                       Foreground="{Binding Source, Converter={StaticResource DirectionColorConverter}}"
                                       Margin="0,0,8,0"
                                       Width="24"
                                       VerticalAlignment="Center" />
                            
                            <!-- Content -->
                            <TextBlock Grid.Column="3" 
                                       Text="{Binding Content}" 
                                       FontFamily="{Binding MessageFontFamily, ElementName=Root}" 
                                       FontSize="{Binding MessageFontSize, ElementName=Root}" 
                                       Foreground="#E6EDF3"
                                       TextWrapping="NoWrap"
                                       TextTrimming="CharacterEllipsis"
                                       VerticalAlignment="Center" />
                        </Grid>
                    </Border>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>
    </Grid>
</UserControl>
